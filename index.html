<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAU Journal Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library to read XLSX files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* LAU Style Guide Inspired Customizations */
        body {
            font-family: 'PT Sans', sans-serif;
            background-color: #f4f4f5; /* A light gray background */
        }
        .lau-green {
            color: #006751;
        }
        .bg-lau-green {
            background-color: #006751;
        }
        .border-lau-green {
            border-color: #006751;
        }
        h1, h2, h3 {
            font-family: 'Raleway', sans-serif;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-color: #006751;
            background-color: #006751;
            color: white;
        }
        .search-input::placeholder {
            color: #9ca3af;
            font-style: italic;
        }
        .result-card {
            border-left: 5px solid #006751;
        }
        .filter-label {
            font-weight: 500;
            color: #374151;
            font-family: 'Raleway', sans-serif;
        }
        .summary-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .summary-item:hover {
            background-color: #f9fafb;
        }
        #progress-bar {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <img src="https://100.lau.edu.lb/images/LAU_Centennial_Primary_Logo_RGB_full_colors.png" alt="LAU Logo" class="h-24 mx-auto mb-4" onerror="this.onerror=null;this.src='https://www.lau.edu.lb/2022/images/lau-logo-text-black.png';">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">ORBIT Rankings and Beyond</h1>
            <p class="text-gray-600 mt-2">Your guide to journal rankings and classifications.</p>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="bg-white p-6 rounded-lg shadow-lg">
            <!-- Tab Navigation -->
            <div id="tab-container" class="mb-6 border-b border-gray-200 hidden">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tab-journal-search" class="tab-button active text-gray-600 py-3 px-4 text-sm font-medium text-center rounded-t-lg border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300">
                        Search for a Journal
                    </button>
                    <button id="tab-filter-search" class="tab-button text-gray-600 py-3 px-4 text-sm font-medium text-center rounded-t-lg border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300">
                        Search by Field / Rank
                    </button>
                </nav>
            </div>

            <!-- Search by Journal Section -->
            <div id="panel-journal-search" class="hidden">
                <p class="text-gray-600 mb-4">Enter a journal name or ISSN to find its rank.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="journal-input" class="search-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-lau-green" placeholder="Enter journal name or ISSN">
                    <button id="search-btn" class="bg-lau-green text-white px-6 py-2 rounded-md hover:bg-opacity-90 transition">Search</button>
                </div>
            </div>

            <!-- Search by Field/Rank Section -->
            <div id="panel-filter-search" class="hidden">
                 <p class="text-gray-600 mb-4">Filter journals by selecting a rank, academic discipline, and/or scientific field.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
                    <div class="flex flex-col">
                        <label for="rank-select" class="filter-label mb-1">Rank</label>
                        <select id="rank-select" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-lau-green"></select>
                    </div>
                    <div class="flex flex-col">
                        <label for="discipline-select" class="filter-label mb-1">Academic Discipline</label>
                        <select id="discipline-select" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-lau-green"></select>
                    </div>
                    <div class="flex flex-col">
                        <label for="field-select" class="filter-label mb-1">Scientific Field</label>
                        <select id="field-select" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-lau-green" disabled></select>
                    </div>
                    <button id="filter-btn" class="bg-lau-green text-white px-6 py-2 rounded-md hover:bg-opacity-90 transition h-10">Filter</button>
                </div>
            </div>

            <!-- Results Section / Loading Indicator -->
            <div id="results-container" class="mt-8">
                <!-- Search results will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <script>
        const journalInput = document.getElementById('journal-input');
        const searchBtn = document.getElementById('search-btn');
        const filterBtn = document.getElementById('filter-btn');
        const resultsContainer = document.getElementById('results-container');
        const rankSelect = document.getElementById('rank-select');
        const disciplineSelect = document.getElementById('discipline-select');
        const fieldSelect = document.getElementById('field-select');

        const tabContainer = document.getElementById('tab-container');
        const tabJournalSearch = document.getElementById('tab-journal-search');
        const tabFilterSearch = document.getElementById('tab-filter-search');
        const panelJournalSearch = document.getElementById('panel-journal-search');
        const panelFilterSearch = document.getElementById('panel-filter-search');

        let journalData = [];
        let currentActiveTab = 'journal';

        // Levenshtein distance function for finding similar strings
        const levenshteinDistance = (a, b) => {
            const an = a ? a.length : 0;
            const bn = b ? b.length : 0;
            if (an === 0) return bn;
            if (bn === 0) return an;
            const matrix = new Array(bn + 1);
            for (let i = 0; i <= bn; ++i) { matrix[i] = new Array(an + 1); }
            for (let i = 0; i <= an; ++i) { matrix[0][i] = i; }
            for (let j = 0; j <= bn; ++j) { matrix[j][0] = j; }
            for (let j = 1; j <= bn; ++j) {
                for (let i = 1; i <= an; ++i) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + cost);
                }
            }
            return matrix[bn][an];
        };
        
        // Renders the full-detail cards (for direct search)
        const displayFullDetailCards = (results, message = '') => {
            resultsContainer.innerHTML = '';
            
            const statusMessage = document.createElement('p');
            statusMessage.className = 'text-gray-600 italic my-4';
            if (message) {
                statusMessage.textContent = message;
            } else if (results.length > 0) {
                statusMessage.textContent = `Found ${results.length} journal(s).`;
            }
            resultsContainer.appendChild(statusMessage);

            if (results.length === 0) {
                if (!message) {
                     statusMessage.textContent = 'No journals found.';
                }
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
            results.forEach(journal => {
                grid.appendChild(createDetailCard(journal));
            });
            resultsContainer.appendChild(grid);
        };

        // Renders a single detail view (for filter-by-rank click)
        const displaySingleDetailView = (journal, originalList) => {
            resultsContainer.innerHTML = '';
            
            const backButton = document.createElement('button');
            backButton.textContent = 'â† Back to list';
            backButton.className = 'mb-4 text-sm lau-green font-semibold hover:underline';
            backButton.onclick = () => displayFilterList(originalList);
            resultsContainer.appendChild(backButton);
            
            resultsContainer.appendChild(createDetailCard(journal));
        };

        // Renders the summary list (for filter-by-rank)
        const displayFilterList = (results) => {
            resultsContainer.innerHTML = '';

            const countMessage = document.createElement('p');
            countMessage.className = 'text-gray-800 font-semibold mb-4';
            countMessage.textContent = `Found ${results.length} journal(s) for the selected criteria.`;
            resultsContainer.appendChild(countMessage);

            if (results.length === 0) {
                return;
            }

            const listContainer = document.createElement('div');
            listContainer.className = 'space-y-2';

            results.forEach(journal => {
                const item = document.createElement('div');
                item.className = 'summary-item flex justify-between items-center p-3 border rounded-md';
                item.innerHTML = `
                    <span class="font-medium text-gray-800">${journal.Name || 'N/A'}</span>
                    <span class="lau-green font-semibold text-sm">${journal.LAU_ORBIT_Rank || 'N/A'}</span>
                `;
                item.onclick = () => displaySingleDetailView(journal, results);
                listContainer.appendChild(item);
            });
            resultsContainer.appendChild(listContainer);
        };
        
        // Helper to create a single detail card element
        const createDetailCard = (journal) => {
            const card = document.createElement('div');
            card.className = 'result-card bg-white rounded-lg shadow-md p-5';
            const formatValue = (value, isZeroRed = false) => {
                if (value === null || value === undefined || value === '') return 'N/A';
                if (isZeroRed && (String(value) === '0')) return `<span class="text-red-600 font-bold">Zero</span>`;
                return value;
            };
            card.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-3">${journal.Name || 'N/A'}</h3>
                <div class="space-y-2 text-sm text-gray-600">
                    <p><strong>ISSN1:</strong> ${formatValue(journal.ISSN1)}</p>
                    <p><strong>ISSN2:</strong> ${formatValue(journal.ISSN2)}</p>
                    <p><strong>LAU ORBIT Rank:</strong> <span class="lau-green font-semibold">${formatValue(journal.LAU_ORBIT_Rank)}</span></p>
                    <p><strong>JUFO Level:</strong> ${formatValue(journal.JUFOLevel, true)}</p>
                    <p><strong>AVDC 2022:</strong> ${formatValue(journal.AVDC2022)}</p>
                    <p><strong>FNEGE 2022:</strong> ${formatValue(journal.FNEGE2022)}</p>
                    <p><strong>AJG 2024:</strong> ${formatValue(journal.AJG2024)}</p>
                    <p><strong>VHB 2024:</strong> ${formatValue(journal.VHB2024)}</p>
                    <p><strong>Norwegian Level:</strong> ${formatValue(journal.NorwegianLevel, true)}</p>
                    <p><strong>NPI Academic Discipline:</strong> ${formatValue(journal.NPIAcademicDiscipline)}</p>
                    <p><strong>NPI Scientific Field:</strong> ${formatValue(journal.NPIScientificField)}</p>
                    <p><strong>Publisher:</strong> ${formatValue(journal.PublishingCompany)}</p>
                </div>
            `;
            return card;
        };

        // Search by journal name or ISSN
        const handleSearch = () => {
            const query = journalInput.value.trim().toLowerCase();
            if (!query) {
                displayFullDetailCards([], 'Please enter a search term.');
                return;
            }
            const isIssn = /^\d{4}-?\d{3}[\dxX]$/.test(query);
            let results = [];
            if (isIssn) {
                const issnQuery = query.replace('-', '');
                results = journalData.filter(j => (j.ISSN1 && String(j.ISSN1).replace('-', '') === issnQuery) || (j.ISSN2 && String(j.ISSN2).replace('-', '') === issnQuery));
            } else {
                results = journalData.filter(j => j.Name && j.Name.toLowerCase() === query);
                if (results.length === 0) {
                    const similarResults = journalData.filter(j => j.Name && levenshteinDistance(j.Name.toLowerCase(), query) <= 2);
                    if (similarResults.length > 0) {
                        displayFullDetailCards(similarResults, 'Journal not found, but here are some possible matches:');
                    } else {
                        displayFullDetailCards([], 'Journal not found.');
                    }
                    return;
                }
            }
            displayFullDetailCards(results);
        };

        // Filter by fields
        const handleFilter = () => {
            const selectedRank = rankSelect.value;
            const selectedDiscipline = disciplineSelect.value;
            const selectedField = fieldSelect.value;
            let filteredData = journalData.filter(j => {
                const rankMatch = selectedRank === 'All' || String(j.LAU_ORBIT_Rank) === selectedRank;
                const disciplineMatch = selectedDiscipline === 'All' || j.NPIAcademicDiscipline === selectedDiscipline;
                const fieldMatch = selectedField === 'All' || j.NPIScientificField === selectedField;
                return rankMatch && disciplineMatch && fieldMatch;
            });

            // Sort results alphabetically by name
            filteredData.sort((a, b) => (a.Name || '').localeCompare(b.Name || ''));

            displayFilterList(filteredData);
        };

        // Populate dropdowns
        const populateDropdowns = () => {
            const rankOrder = ['A+', 'A', 'B', 'C', 'D+', 'D', 'E', 'F'];
            const ranks = ['All', ...[...new Set(journalData.map(j => j.LAU_ORBIT_Rank).filter(Boolean))].sort((a, b) => {
                const indexA = rankOrder.indexOf(a);
                const indexB = rankOrder.indexOf(b);
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a.localeCompare(b);
            })];
            
            const disciplines = ['All', ...new Set(journalData.map(j => j.NPIAcademicDiscipline).filter(Boolean).sort())];
            rankSelect.innerHTML = ranks.map(r => `<option value="${r}">${r}</option>`).join('');
            disciplineSelect.innerHTML = disciplines.map(d => `<option value="${d}">${d}</option>`).join('');
            updateFieldDropdown();
        };

        // Update scientific field dropdown based on discipline
        const updateFieldDropdown = () => {
            const selectedDiscipline = disciplineSelect.value;
            let fields;
            if (selectedDiscipline === 'All') {
                fields = ['All'];
                fieldSelect.value = 'All';
                fieldSelect.disabled = true;
            } else {
                fields = ['All', ...new Set(journalData.filter(j => j.NPIAcademicDiscipline === selectedDiscipline).map(j => j.NPIScientificField).filter(Boolean).sort())];
                fieldSelect.disabled = false;
            }
            fieldSelect.innerHTML = fields.map(f => `<option value="${f}">${f}</option>`).join('');
        };

        // Tab switching logic
        const switchTab = (activeTab) => {
            currentActiveTab = activeTab;
            if (activeTab === 'journal') {
                tabJournalSearch.classList.add('active');
                tabFilterSearch.classList.remove('active');
                panelJournalSearch.classList.remove('hidden');
                panelFilterSearch.classList.add('hidden');
            } else {
                tabJournalSearch.classList.remove('active');
                tabFilterSearch.classList.add('active');
                panelJournalSearch.classList.add('hidden');
                panelFilterSearch.classList.remove('hidden');
            }
            resultsContainer.innerHTML = ''; // Clear results on tab switch
        };

        // Event Listeners for the main app
        searchBtn.addEventListener('click', handleSearch);
        journalInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSearch(); });
        filterBtn.addEventListener('click', handleFilter);
        disciplineSelect.addEventListener('change', updateFieldDropdown);
        tabJournalSearch.addEventListener('click', () => switchTab('journal'));
        tabFilterSearch.addEventListener('click', () => switchTab('filter'));
        
        // Load data on page load from URL
        window.addEventListener('DOMContentLoaded', async () => {
            resultsContainer.innerHTML = `
                <div id="loading-container" class="w-full max-w-md mx-auto">
                    <p class="text-center text-gray-600 mb-2">Loading journal data...</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-lau-green h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            `;
            const progressBar = document.getElementById('progress-bar');

            try {
                const response = await fetch('https://raw.githubusercontent.com/lauorbit/lauorbit/main/ORBIT.xlsx');
                 if (!response.ok) { throw new Error('Network response was not ok.'); }
                
                const contentLength = +response.headers.get('Content-Length');
                let receivedLength = 0;
                const chunks = [];
                const reader = response.body.getReader();

                while(true) {
                    const { done, value } = await reader.read();
                    if (done) { break; }
                    chunks.push(value);
                    receivedLength += value.length;
                    if (contentLength) {
                        const progress = (receivedLength / contentLength) * 100;
                        progressBar.style.width = `${progress}%`;
                    }
                }

                let chunksAll = new Uint8Array(receivedLength);
                let position = 0;
                for(let chunk of chunks) {
                    chunksAll.set(chunk, position);
                    position += chunk.length;
                }

                const arrayBuffer = chunksAll.buffer;
                const workbook = XLSX.read(arrayBuffer, {type: 'buffer'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                journalData = XLSX.utils.sheet_to_json(worksheet, {defval: ""});
                
                // Show the main UI
                document.getElementById('loading-container').remove();
                tabContainer.classList.remove('hidden');
                panelJournalSearch.classList.remove('hidden');
                
                populateDropdowns();
                resultsContainer.innerHTML = ''; // Clear loading message
            } catch (error) {
                console.error('Error loading journal data:', error);
                resultsContainer.innerHTML = `<p class="text-center text-red-500">Failed to load journal data. Please check the URL and your internet connection.</p>`;
            }
        });

    </script>
</body>
</html>
